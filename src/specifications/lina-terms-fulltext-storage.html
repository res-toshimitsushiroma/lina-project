<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINA - åˆ©ç”¨è¦ç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå…¨æ–‡ä¿å­˜ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #d4a574;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        pre {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .code-block {
            margin: 15px 0;
        }
        
        .code-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
        }
        
        .highlight {
            background: #fffde7;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 15px 0;
            font-size: 13px;
            color: #666;
        }
        
        .api-endpoint {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        
        .api-method {
            display: inline-block;
            padding: 3px 8px;
            background: #2196f3;
            color: white;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .api-path {
            font-family: monospace;
            color: #333;
        }
        
        .flow-diagram {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .flow-number {
            background: #f57c00;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .flow-text {
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ LINA åˆ©ç”¨è¦ç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å…¨æ–‡ä¿å­˜å®Ÿè£…</h1>
        
        <!-- ãƒ‡ãƒ¼ã‚¿æ§‹é€  -->
        <div class="section">
            <h2 class="section-title">1. ãƒ‡ãƒ¼ã‚¿æ§‹é€ è¨­è¨ˆ</h2>
            
            <div class="code-block">
                <div class="code-title">äºˆç´„æ™‚ã®åˆ©ç”¨è¦ç´„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆJSONï¼‰</div>
                <pre>{
  "reservation_id": "R-2024-0610-0123",
  "customer_id": "C2024-0542",
  "salon_id": "LINA2024",
  "agreed_at": "2024-06-10T10:45:23.456Z",
  
  "terms_snapshot": {
    "version": "2.1.0",
    "generated_at": "2024-06-10T10:45:20.000Z",
    "hash": "sha256:7d865e959b2466918c9863afca942d0fb89d7c9ac0c99bafc3749504ded97730",
    
    "terms": [
      {
        "id": "age_consent",
        "title": "18æ­³æœªæº€ã®è¦ªæ¨©è€…åŒæ„",
        "enabled": true,
        "order": 1,
        "content": "18æ­³æœªæº€ã®ãŠå®¢æ§˜ãŒæ–½è¡“ã‚’å—ã‘ã‚‹å ´åˆã€è¦ªæ¨©è€…ã®åŒæ„ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚\nã”äºˆç´„æ™‚ã«è¦ªæ¨©è€…ã®åŒæ„ã‚’å¾—ã¦ã„ã‚‹ã“ã¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\nãªãŠã€è¦ªæ¨©è€…ã®åŒæ„ç¢ºèªã¯ãŠå®¢æ§˜ã®è‡ªå·±ç”³å‘Šã«åŸºã¥ãã‚‚ã®ã¨ã—ã€äºˆç´„ã‚·ã‚¹ãƒ†ãƒ æä¾›è€…ï¼ˆLINAï¼‰ã¯ãã®çœŸå½ã«ã¤ã„ã¦ç¢ºèªã™ã‚‹ç¾©å‹™ã‚’è² ã‚ãšã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚\nåŒæ„ã®ç¢ºèªãŠã‚ˆã³ç®¡ç†ã¯å½“ã‚µãƒ­ãƒ³ã®è²¬ä»»ã«ãŠã„ã¦è¡Œã„ã¾ã™ã€‚"
      },
      {
        "id": "harassment_prevention",
        "title": "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆé˜²æ­¢",
        "enabled": true,
        "order": 2,
        "content": "ãŠå®¢æ§˜ã«ã¯ã€å½“ã‚µãƒ­ãƒ³ã‚¹ã‚¿ãƒƒãƒ•ã«å¯¾ã—ã¦ä»¥ä¸‹ã®è¡Œç‚ºã‚’è¡Œã‚ãªã„ã“ã¨ã‚’ãŠç´„æŸã„ãŸã ãã¾ã™ï¼š\nãƒ»æš´è¨€ã€å¨åœ§ã€è„…è¿«ç­‰ã®ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆè¡Œç‚º\nãƒ»æ€§çš„ãªç™ºè¨€ã€æ¥è§¦ã€è¦æ±‚ç­‰ã®ã‚»ã‚¯ã‚·ãƒ£ãƒ«ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ\nãƒ»ã‚ã„ã›ã¤ãªè¨€å‹•ã¾ãŸã¯è¡Œç‚º\nãƒ»æ¥­å‹™ã®å††æ»‘ãªé‚è¡Œã‚’å¦¨ã’ã‚‹è¡Œç‚º\nãƒ»ãã®ä»–ã€ç¤¾ä¼šé€šå¿µä¸Šä¸é©åˆ‡ã¨åˆ¤æ–­ã•ã‚Œã‚‹è¡Œç‚º\n\né•åãŒã‚ã£ãŸå ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›ã‚’ä¸­æ­¢ã—ã€äºˆç´„ã®å–æ¶ˆã€ä»Šå¾Œã®åˆ©ç”¨åœæ­¢ç­‰ã®æªç½®ã‚’å–ã‚‰ã›ã¦ã„ãŸã ãã¾ã™ã€‚\nãªãŠã€ã“ã‚Œã‚‰ã®å¯¾å¿œã«ã¤ã„ã¦äºˆç´„ã‚·ã‚¹ãƒ†ãƒ æä¾›è€…ï¼ˆLINAï¼‰ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚"
      }
    ]
  },
  
  "agreement_evidence": {
    "ip_address": "203.0.113.42",
    "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X)",
    "device_info": {
      "type": "mobile",
      "os": "iOS",
      "os_version": "17.2",
      "browser": "Safari",
      "browser_version": "17.2"
    },
    "geolocation": {
      "country": "JP",
      "region": "Okinawa",
      "city": "Naha"
    },
    "session_id": "sess_2024061010452300123",
    "signature": "ECDSA:3045022100abc...def"
  }
}</pre>
            </div>
            
            <div class="highlight">
                <strong>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼š</strong><br>
                ãƒ»è¦ç´„ã®å…¨æ–‡ï¼ˆcontentï¼‰ã‚’å®Œå…¨ä¿å­˜<br>
                ãƒ»ãƒãƒƒã‚·ãƒ¥å€¤ã§æ”¹ã–ã‚“æ¤œè¨¼å¯èƒ½<br>
                ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã§å¤‰æ›´å±¥æ­´è¿½è·¡<br>
                ãƒ»æŠ€è¡“çš„è¨¼è·¡ï¼ˆIPã€ãƒ‡ãƒã‚¤ã‚¹ç­‰ï¼‰ã‚‚è¨˜éŒ²
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ -->
        <div class="section">
            <h2 class="section-title">2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆPostgreSQLï¼‰</h2>
            
            <div class="code-block">
                <div class="code-title">ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©</div>
                <pre>-- åˆ©ç”¨è¦ç´„ãƒã‚¹ã‚¿ï¼ˆç¾åœ¨æœ‰åŠ¹ãªè¦ç´„ï¼‰
CREATE TABLE terms_master (
    id SERIAL PRIMARY KEY,
    salon_id VARCHAR(10) NOT NULL,
    term_type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    version VARCHAR(10) NOT NULL,
    is_active BOOLEAN DEFAULT true,
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(salon_id, term_type, version)
);

-- åˆ©ç”¨è¦ç´„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆäºˆç´„æ™‚ç‚¹ã®å…¨æ–‡ä¿å­˜ï¼‰
CREATE TABLE terms_snapshots (
    id SERIAL PRIMARY KEY,
    snapshot_id VARCHAR(50) UNIQUE NOT NULL, -- UUIDå½¢å¼
    salon_id VARCHAR(10) NOT NULL,
    version VARCHAR(10) NOT NULL,
    terms_data JSONB NOT NULL, -- è¦ç´„å…¨æ–‡ã‚’å«ã‚€JSON
    content_hash VARCHAR(256) NOT NULL, -- SHA-256ãƒãƒƒã‚·ãƒ¥
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_snapshot_salon (salon_id, created_at DESC)
);

-- åŒæ„è¨˜éŒ²ï¼ˆè»½é‡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE terms_agreements (
    id SERIAL PRIMARY KEY,
    reservation_id VARCHAR(20) UNIQUE NOT NULL,
    customer_id VARCHAR(15) NOT NULL,
    salon_id VARCHAR(10) NOT NULL,
    snapshot_id VARCHAR(50) REFERENCES terms_snapshots(snapshot_id),
    agreed_at TIMESTAMP NOT NULL,
    ip_address INET,
    user_agent TEXT,
    device_info JSONB,
    geolocation JSONB,
    session_id VARCHAR(100),
    digital_signature TEXT, -- ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å
    is_valid BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_customer_agreements (customer_id, agreed_at DESC),
    INDEX idx_salon_agreements (salon_id, agreed_at DESC),
    INDEX idx_reservation (reservation_id)
);

-- è¦ç´„å¤‰æ›´å±¥æ­´ï¼ˆç›£æŸ»ç”¨ï¼‰
CREATE TABLE terms_change_log (
    id SERIAL PRIMARY KEY,
    salon_id VARCHAR(10) NOT NULL,
    term_type VARCHAR(50) NOT NULL,
    old_version VARCHAR(10),
    new_version VARCHAR(10),
    old_content TEXT,
    new_content TEXT,
    changed_by VARCHAR(50), -- ã‚¹ã‚¿ãƒƒãƒ•ID
    change_reason TEXT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_salon_changes (salon_id, changed_at DESC)
);</pre>
            </div>
        </div>
        
        <!-- APIè¨­è¨ˆ -->
        <div class="section">
            <h2 class="section-title">3. APIè¨­è¨ˆ</h2>
            
            <div class="api-endpoint">
                <span class="api-method">POST</span>
                <span class="api-path">/api/v1/reservations/{reservationId}/terms-agreement</span>
            </div>
            
            <div class="code-block">
                <div class="code-title">ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆäºˆç´„æ™‚ã®åŒæ„ä¿å­˜ï¼‰</div>
                <pre>{
  "customer_id": "C2024-0542",
  "agreed_terms": ["age_consent", "harassment_prevention"],
  "client_info": {
    "ip_address": "203.0.113.42",
    "user_agent": "Mozilla/5.0...",
    "timestamp": "2024-06-10T10:45:23.456Z"
  }
}</pre>
            </div>
            
            <div class="code-block">
                <div class="code-title">ãƒ¬ã‚¹ãƒãƒ³ã‚¹</div>
                <pre>{
  "success": true,
  "data": {
    "agreement_id": "AGR-2024-0610-0123",
    "snapshot_id": "snap_7d865e959b246691",
    "hash": "sha256:7d865e959b2466918c9863afca942d0fb89d7c9ac0c99bafc3749504ded97730",
    "timestamp": "2024-06-10T10:45:23.456Z",
    "message": "åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ"
  }
}</pre>
            </div>
            
            <div class="api-endpoint">
                <span class="api-method">GET</span>
                <span class="api-path">/api/v1/customers/{customerId}/terms-history</span>
            </div>
            
            <div class="code-block">
                <div class="code-title">ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆé¡§å®¢ã®åŒæ„å±¥æ­´å–å¾—ï¼‰</div>
                <pre>{
  "customer_id": "C2024-0542",
  "agreements": [
    {
      "reservation_id": "R-2024-1225-0456",
      "agreed_at": "2024-12-25T14:00:00Z",
      "menu": "ã¾ã¤ã’ãƒ‘ãƒ¼ãƒ",
      "terms": [
        {"id": "appropriate_use", "title": "å¥å…¨é‹å–¶ãƒãƒªã‚·ãƒ¼"},
        {"id": "harassment_prevention", "title": "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆé˜²æ­¢"}
      ],
      "snapshot_id": "snap_abc123def456"
    },
    {
      "reservation_id": "R-2024-0610-0123",
      "agreed_at": "2024-06-10T10:45:23Z",
      "menu": "ãƒã‚¤ãƒ«",
      "terms": [
        {"id": "age_consent", "title": "18æ­³æœªæº€ã®è¦ªæ¨©è€…åŒæ„"}
      ],
      "snapshot_id": "snap_7d865e959b246691"
    }
  ]
}</pre>
            </div>
            
            <div class="api-endpoint">
                <span class="api-method">GET</span>
                <span class="api-path">/api/v1/terms/snapshot/{snapshotId}</span>
            </div>
            
            <div class="code-block">
                <div class="code-title">ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆè¦ç´„å…¨æ–‡å–å¾—ï¼‰</div>
                <pre>{
  "snapshot_id": "snap_7d865e959b246691",
  "version": "2.1.0",
  "created_at": "2024-06-10T10:45:20Z",
  "terms": [
    {
      "id": "age_consent",
      "title": "18æ­³æœªæº€ã®è¦ªæ¨©è€…åŒæ„",
      "content": "18æ­³æœªæº€ã®ãŠå®¢æ§˜ãŒæ–½è¡“ã‚’å—ã‘ã‚‹å ´åˆã€è¦ªæ¨©è€…ã®åŒæ„ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚\nï¼ˆå…¨æ–‡ï¼‰..."
    }
  ],
  "hash": "sha256:7d865e959b246691...",
  "is_valid": true
}</pre>
            </div>
        </div>
        
        <!-- å®Ÿè£…ãƒ•ãƒ­ãƒ¼ -->
        <div class="section">
            <h2 class="section-title">4. å®Ÿè£…ãƒ•ãƒ­ãƒ¼</h2>
            
            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-number">1</div>
                    <div class="flow-text">
                        <strong>äºˆç´„æ™‚</strong><br>
                        ç¾åœ¨æœ‰åŠ¹ãªè¦ç´„ã‚’å–å¾—ã—ã€å…¨æ–‡ã‚’è¡¨ç¤º
                    </div>
                </div>
                
                <div class="flow-step">
                    <div class="flow-number">2</div>
                    <div class="flow-text">
                        <strong>åŒæ„å–å¾—</strong><br>
                        ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§åŒæ„ã‚’ç¢ºèª
                    </div>
                </div>
                
                <div class="flow-step">
                    <div class="flow-number">3</div>
                    <div class="flow-text">
                        <strong>ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ</strong><br>
                        ç¾åœ¨ã®è¦ç´„å…¨æ–‡ã‚’JSONã§ä¿å­˜ã€ãƒãƒƒã‚·ãƒ¥å€¤ç”Ÿæˆ
                    </div>
                </div>
                
                <div class="flow-step">
                    <div class="flow-number">4</div>
                    <div class="flow-text">
                        <strong>åŒæ„è¨˜éŒ²</strong><br>
                        æŠ€è¡“çš„è¨¼è·¡ï¼ˆIPã€ãƒ‡ãƒã‚¤ã‚¹ç­‰ï¼‰ã¨å…±ã«è¨˜éŒ²
                    </div>
                </div>
                
                <div class="flow-step">
                    <div class="flow-number">5</div>
                    <div class="flow-text">
                        <strong>è¨¼è·¡ä¿å­˜</strong><br>
                        æ”¹ã–ã‚“é˜²æ­¢ã®ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚’ä»˜ä¸
                    </div>
                </div>
            </div>
        </div>
        
        <!-- JavaScriptå®Ÿè£…ä¾‹ -->
        <div class="section">
            <h2 class="section-title">5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆJavaScriptï¼‰</h2>
            
            <div class="code-block">
                <div class="code-title">åˆ©ç”¨è¦ç´„ã®åŒæ„å‡¦ç†</div>
                <pre>class TermsAgreementManager {
    constructor() {
        this.currentTerms = null;
        this.snapshotId = null;
    }
    
    // ç¾åœ¨ã®è¦ç´„ã‚’å–å¾—
    async loadCurrentTerms(salonId) {
        const response = await fetch(`/api/v1/salons/${salonId}/terms/current`);
        this.currentTerms = await response.json();
        return this.currentTerms;
    }
    
    // è¦ç´„ã¸ã®åŒæ„ã‚’ä¿å­˜
    async saveAgreement(reservationId, customerId, agreedTerms) {
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’åé›†
        const clientInfo = {
            ip_address: await this.getClientIP(),
            user_agent: navigator.userAgent,
            timestamp: new Date().toISOString(),
            device_info: this.getDeviceInfo(),
            geolocation: await this.getGeolocation()
        };
        
        // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
        const snapshot = {
            version: this.currentTerms.version,
            terms: this.currentTerms.terms.filter(t => agreedTerms.includes(t.id)),
            generated_at: new Date().toISOString()
        };
        
        // ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—
        const hash = await this.calculateHash(JSON.stringify(snapshot));
        
        // APIã«é€ä¿¡
        const response = await fetch(`/api/v1/reservations/${reservationId}/terms-agreement`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                customer_id: customerId,
                agreed_terms: agreedTerms,
                snapshot: snapshot,
                hash: hash,
                client_info: clientInfo
            })
        });
        
        const result = await response.json();
        this.snapshotId = result.data.snapshot_id;
        
        return result;
    }
    
    // SHA-256ãƒãƒƒã‚·ãƒ¥è¨ˆç®—
    async calculateHash(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return `sha256:${hashHex}`;
    }
    
    // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—
    getDeviceInfo() {
        return {
            type: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
            os: this.detectOS(),
            browser: this.detectBrowser(),
            screen: {
                width: window.screen.width,
                height: window.screen.height
            }
        };
    }
    
    // OSæ¤œå‡º
    detectOS() {
        const userAgent = navigator.userAgent;
        if (userAgent.includes('Win')) return 'Windows';
        if (userAgent.includes('Mac')) return 'macOS';
        if (userAgent.includes('Linux')) return 'Linux';
        if (userAgent.includes('Android')) return 'Android';
        if (userAgent.includes('iOS') || userAgent.includes('iPhone')) return 'iOS';
        return 'Unknown';
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
    detectBrowser() {
        const userAgent = navigator.userAgent;
        if (userAgent.includes('Chrome')) return 'Chrome';
        if (userAgent.includes('Safari')) return 'Safari';
        if (userAgent.includes('Firefox')) return 'Firefox';
        if (userAgent.includes('Edge')) return 'Edge';
        return 'Unknown';
    }
    
    // ä½ç½®æƒ…å ±å–å¾—ï¼ˆè¨±å¯ãŒå¿…è¦ï¼‰
    async getGeolocation() {
        return new Promise((resolve) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    () => {
                        resolve(null); // ä½ç½®æƒ…å ±å–å¾—å¤±æ•—
                    }
                );
            } else {
                resolve(null);
            }
        });
    }
    
    // IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ï¼ˆå¤–éƒ¨APIã‚’ä½¿ç”¨ï¼‰
    async getClientIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch {
            return null;
        }
    }
}

// ä½¿ç”¨ä¾‹
const termsManager = new TermsAgreementManager();

// äºˆç´„ç¢ºèªç”»é¢ã§ã®å‡¦ç†
async function handleReservationConfirm() {
    // è¦ç´„ã‚’èª­ã¿è¾¼ã¿
    const terms = await termsManager.loadCurrentTerms('LINA2024');
    
    // è¦ç´„ã‚’è¡¨ç¤º
    displayTerms(terms);
    
    // åŒæ„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
    document.getElementById('confirm-button').addEventListener('click', async () => {
        // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸè¦ç´„ã‚’å–å¾—
        const agreedTerms = getCheckedTerms();
        
        // åŒæ„ã‚’ä¿å­˜
        const result = await termsManager.saveAgreement(
            'R-2024-0610-0123',
            'C2024-0542',
            agreedTerms
        );
        
        if (result.success) {
            console.log('åŒæ„è¨˜éŒ²å®Œäº†:', result.data.snapshot_id);
            // äºˆç´„å®Œäº†ç”»é¢ã¸
        }
    });
}</pre>
            </div>
        </div>
        
        <!-- è¨¼è·¡å‡ºåŠ› -->
        <div class="section">
            <h2 class="section-title">6. æ³•çš„è¨¼è·¡ã®PDFå‡ºåŠ›</h2>
            
            <div class="code-block">
                <div class="code-title">PDFç”Ÿæˆå‡¦ç†ï¼ˆNode.js + PDFKitï¼‰</div>
                <pre>const PDFDocument = require('pdfkit');
const fs = require('fs');

class LegalEvidenceGenerator {
    async generatePDF(agreementData) {
        const doc = new PDFDocument({
            size: 'A4',
            info: {
                Title: 'åˆ©ç”¨è¦ç´„åŒæ„è¨¼è·¡',
                Author: 'LINAäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ',
                Subject: `äºˆç´„ç•ªå·: ${agreementData.reservation_id}`,
                CreationDate: new Date()
            }
        });
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        doc.fontSize(20)
           .text('åˆ©ç”¨è¦ç´„åŒæ„è¨¼è·¡', { align: 'center' });
        
        doc.moveDown();
        
        // åŸºæœ¬æƒ…å ±
        doc.fontSize(12)
           .text(`ç™ºè¡Œæ—¥: ${new Date().toLocaleDateString('ja-JP')}`)
           .text(`äºˆç´„ç•ªå·: ${agreementData.reservation_id}`)
           .text(`é¡§å®¢ID: ${agreementData.customer_id}`)
           .text(`åŒæ„æ—¥æ™‚: ${agreementData.agreed_at}`);
        
        doc.moveDown();
        
        // åŒæ„ã—ãŸè¦ç´„ï¼ˆå…¨æ–‡ï¼‰
        doc.fontSize(14)
           .text('åŒæ„ã—ãŸè¦ç´„å†…å®¹', { underline: true });
        
        agreementData.terms_snapshot.terms.forEach((term, index) => {
            doc.moveDown()
               .fontSize(12)
               .text(`ç¬¬${index + 1}æ¡ ${term.title}`, { bold: true })
               .fontSize(10)
               .text(term.content, { align: 'justify' });
        });
        
        doc.moveDown();
        
        // æŠ€è¡“çš„è¨¼è·¡
        doc.addPage()
           .fontSize(14)
           .text('æŠ€è¡“çš„è¨¼è·¡', { underline: true })
           .moveDown()
           .fontSize(10)
           .text(`IPã‚¢ãƒ‰ãƒ¬ã‚¹: ${agreementData.agreement_evidence.ip_address}`)
           .text(`ãƒ‡ãƒã‚¤ã‚¹: ${agreementData.agreement_evidence.device_info.type}`)
           .text(`OS: ${agreementData.agreement_evidence.device_info.os}`)
           .text(`ãƒ–ãƒ©ã‚¦ã‚¶: ${agreementData.agreement_evidence.device_info.browser}`)
           .text(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${agreementData.agreement_evidence.session_id}`);
        
        // ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å
        doc.moveDown()
           .fontSize(14)
           .text('ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å', { underline: true })
           .fontSize(8)
           .text(`Hash: ${agreementData.terms_snapshot.hash}`)
           .text(`Signature: ${agreementData.agreement_evidence.signature}`);
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        doc.fontSize(8)
           .text('ã“ã®è¨¼è·¡ã¯æ”¹ã–ã‚“é˜²æ­¢å‡¦ç†ãŒæ–½ã•ã‚Œã¦ã„ã¾ã™', { align: 'center' })
           .text('LINAäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', { align: 'center' });
        
        return doc;
    }
    
    async saveToFile(agreementData, filepath) {
        const doc = await this.generatePDF(agreementData);
        doc.pipe(fs.createWriteStream(filepath));
        doc.end();
    }
}</pre>
            </div>
        </div>
        
        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥ -->
        <div class="section">
            <h2 class="section-title">7. ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥</h2>
            
            <div class="code-block">
                <div class="code-title">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</div>
                <pre># PostgreSQLè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆcronè¨­å®šï¼‰
# æ¯æ—¥åˆå‰3æ™‚ã«å®Ÿè¡Œ
0 3 * * * pg_dump -U postgres -d lina_db -t terms_snapshots -t terms_agreements > /backup/terms_$(date +\%Y\%m\%d).sql

# Google Cloud Storageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
0 4 * * * gsutil cp /backup/terms_$(date +\%Y\%m\%d).sql gs://lina-backup/terms/

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
0 5 * * * find /backup -name "terms_*.sql" -mtime +30 -delete

# é•·æœŸä¿å­˜ï¼ˆæ³•çš„è¦ä»¶ï¼š7å¹´é–“ï¼‰
# æœˆæ¬¡ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
0 0 1 * * tar czf /archive/terms_$(date +\%Y\%m).tar.gz /backup/terms_*.sql</pre>
            </div>
            
            <div class="highlight">
                <strong>ğŸ”’ ä¿å­˜æœŸé–“ã®æ¨å¥¨ï¼š</strong><br>
                ãƒ»é€šå¸¸ã®åŒæ„è¨˜éŒ²ï¼š3å¹´é–“<br>
                ãƒ»æœªæˆå¹´è€…é–¢é€£ï¼šæˆäººå¾Œ3å¹´é–“ï¼ˆæœ€é•·21å¹´ï¼‰<br>
                ãƒ»ãƒˆãƒ©ãƒ–ãƒ«æ¡ˆä»¶ï¼šè§£æ±ºå¾Œ7å¹´é–“<br>
                ãƒ»ä¼šè¨ˆé–¢é€£ï¼š7å¹´é–“ï¼ˆç¨å‹™è¦ä»¶ï¼‰
            </div>
        </div>
        
        <!-- ã¾ã¨ã‚ -->
        <div class="section">
            <h2 class="section-title">8. å®Ÿè£…ã®ãƒ¡ãƒªãƒƒãƒˆ</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #2e7d32;">âœ… å®Œå…¨ãªæ³•çš„ä¿è­·</h3>
                    <p style="font-size: 12px; color: #333;">
                        è¦ç´„ã®å…¨æ–‡ã¨æŠ€è¡“çš„è¨¼è·¡ã‚’å®Œå…¨ä¿å­˜ã€‚<br>
                        è£åˆ¤ç­‰ã§ã‚‚è¨¼æ‹ ã¨ã—ã¦æå‡ºå¯èƒ½ã€‚
                    </p>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #1976d2;">ğŸ” æ”¹ã–ã‚“é˜²æ­¢</h3>
                    <p style="font-size: 12px; color: #333;">
                        SHA-256ãƒãƒƒã‚·ãƒ¥ã¨ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã§<br>
                        ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§ã‚’ä¿è¨¼ã€‚
                    </p>
                </div>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #f57c00;">ğŸ“Š è¦ç´„å¤‰æ›´å¯¾å¿œ</h3>
                    <p style="font-size: 12px; color: #333;">
                        è¦ç´„ã‚’å¤‰æ›´ã—ã¦ã‚‚éå»ã®åŒæ„å†…å®¹ã¯<br>
                        ãã®ã¾ã¾ä¿æŒã€‚æ™‚ç³»åˆ—ã§è¿½è·¡å¯èƒ½ã€‚
                    </p>
                </div>
                
                <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #c2185b;">ğŸš¨ å³åº§ã®å¯¾å¿œ</h3>
                    <p style="font-size: 12px; color: #333;">
                        ã‚¯ãƒ¬ãƒ¼ãƒ æ™‚ã«ã™ãè¨¼è·¡ã‚’æç¤ºã€‚<br>
                        PDFå‡ºåŠ›ã§å¤–éƒ¨æå‡ºã‚‚ç°¡å˜ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
